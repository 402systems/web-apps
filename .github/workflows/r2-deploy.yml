name: Deploy Frontend Apps to R2
on:
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build all apps
        run: pnpm build
      - name: Upload Apps to R2
        shell: bash
        run: |
          # Define the root of your artifacts in R2
          COMMIT_HASH=$(git rev-parse --short HEAD)
          R2_ENDPOINT="https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com"
          # 1. Find all 'out' folders under 'apps/'
          find apps -type d -name "out" | while read -r dist_path; do
            # If dist_path is "apps/marketing/blog/out"
            # 'app_dir' becomes "apps/marketing/blog"
            app_dir=$(dirname "$dist_path")
            # 'app_name' becomes "blog"
            app_name=$(basename "$app_dir")
            # Get the team folder: "apps/marketing"
            team_dir=$(dirname "$app_dir")
            # Get the team name: "marketing"
            team_name=$(basename "$team_dir")
            DEPLOY_ID="${team_name}-${app_name}"
            echo "ðŸš€ Deploying App: $DEPLOY_ID from $dist_path"
            # Sync to R2
            # Final Path: artifacts/<commit_id>/blog/
            aws s3 sync "$dist_path" \
              "s3://${{ secrets.R2_BUCKET_NAME }}/artifacts/${COMMIT_HASH}/${DEPLOY_ID}/" \
              --endpoint-url "$R2_ENDPOINT" \
              --region auto
          done
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }} 
          # Note: Alternatively, use the 'ryand56/r2-upload-action' for a simpler UI
